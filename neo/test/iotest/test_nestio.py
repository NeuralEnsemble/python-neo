# -*- coding: utf-8 -*-
"""
Tests of neo.io.nestio
"""

# needed for python 3 compatibility
from __future__ import absolute_import, division
import os
try:
    import unittest2 as unittest
except ImportError:
    import unittest
import tempfile
import numpy as np
from numpy.testing import assert_array_equal
from quantities import ms, pS

from neo.io.nestio import NESTSpikeIO, NESTMultimeterIO
#from neo.test.iotest.common_io_test import BaseTestIO


# class TestNESTSpikeIO(BaseTestIO, unittest.TestCase):
#     ioclass = NESTSpikeIO
#     files_to_test = ['fake1',
#                      'fake2',
#                      ]
#     files_to_download = []


class TestNESTSpikeIO(unittest.TestCase):

    def setUp(self):
        fp = tempfile.NamedTemporaryFile(mode='w', delete=False)
        self.test_file = fp.name
        fp.write(test_spike_data)
        fp.close()

    def tearDown(self):
        os.remove(self.test_file)

    def test_read_spiketrain(self):
        io = NESTSpikeIO(filename=self.test_file)
        spiketrain = io.read_spiketrain(gdf_id=1, t_stop=100.0*ms, lazy=False)
        assert_array_equal(spiketrain.magnitude, np.array([10.0, 20.0, 50.0]))

    def test_read_block(self):
        io = NESTSpikeIO(filename=self.test_file)
        block = io.read_block(t_stop=1000.0*ms)
        for spiketrain in block.segments[0].spiketrains:
            if spiketrain.annotations["id"] == 1:
                assert_array_equal(spiketrain.magnitude, np.array([10.0, 20.0, 50.0]))
            elif spiketrain.annotations["id"] == 3:
                assert_array_equal(spiketrain.magnitude, np.array([15.0, 25.0, 55.0]))
            else:
                self.fail("Unexpected id, or no id")


class TestNESTMultimeterIO(unittest.TestCase):

    def setUp(self):
        fp = tempfile.NamedTemporaryFile(mode='w', delete=False)
        self.test_file = fp.name
        fp.write(test_multimeter_data)
        fp.close()

    def tearDown(self):
        os.remove(self.test_file)

    def test_read_analogsignal(self):
        io = NESTMultimeterIO(filename=self.test_file)
        segment = io.read_segment(variables=["var1", "var2", "var3"],
                                  units=["ms", "nA", "pS"])
        self.assertEqual(len(segment.analogsignals), 3)
        self.assertEqual(segment.analogsignals[0].shape, (200, 2))

        data = np.loadtxt(self.test_file)
        data_gid3 = data[data[:, 0] == 3]
        var1_gid3 = data_gid3[:, 2]
        assert_array_equal(segment.analogsignals[0][:, 1].magnitude.flat, var1_gid3)
        self.assertEqual(segment.analogsignals[2].units, pS)


test_spike_data = """\
1	10.000
3	15.000
1	20.000
3	25.000
1	50.000
3	55.000
"""

test_multimeter_data = """\
1	0.100	-70.000	0.000	0.000
1	0.200	-70.000	0.000	0.000
1	0.300	-70.000	0.000	0.000
1	0.400	-70.000	0.000	0.000
1	0.500	-70.000	0.000	0.000
1	0.600	-70.000	0.000	0.000
1	0.700	-70.000	0.000	0.000
1	0.800	-70.000	0.000	0.000
1	0.900	-70.000	0.000	0.000
1	1.000	-70.000	0.000	0.000
3	0.100	-70.000	0.000	0.000
3	0.200	-70.000	0.000	0.000
3	0.300	-70.000	0.000	0.000
3	0.400	-70.000	0.000	0.000
3	0.500	-70.000	0.000	0.000
3	0.600	-70.000	0.000	0.000
3	0.700	-70.000	0.000	0.000
3	0.800	-70.000	0.000	0.000
3	0.900	-70.000	0.000	0.000
3	1.000	-70.000	0.000	0.000
1	1.100	-70.000	0.000	0.000
1	1.200	-70.000	0.000	0.000
1	1.300	-70.000	0.000	0.000
1	1.400	-70.000	0.000	0.000
1	1.500	-70.000	0.000	0.000
1	1.600	-70.000	0.000	0.000
1	1.700	-70.000	0.000	0.000
1	1.800	-70.000	0.000	0.000
1	1.900	-70.000	0.000	0.000
1	2.000	-70.000	0.000	0.000
3	1.100	-70.000	0.000	0.000
3	1.200	-70.000	0.000	0.000
3	1.300	-70.000	0.000	0.000
3	1.400	-70.000	0.000	0.000
3	1.500	-70.000	0.000	0.000
3	1.600	-70.000	0.000	0.000
3	1.700	-70.000	0.000	0.000
3	1.800	-70.000	0.000	0.000
3	1.900	-70.000	0.000	0.000
3	2.000	-70.000	0.000	0.000
1	2.100	-70.000	0.000	0.000
1	2.200	-70.000	0.000	0.000
1	2.300	-70.000	0.000	0.000
1	2.400	-70.000	0.000	0.000
1	2.500	-70.000	0.000	0.000
1	2.600	-70.000	0.000	0.000
1	2.700	-70.000	0.000	0.000
1	2.800	-70.000	0.000	0.000
1	2.900	-70.000	0.000	0.000
1	3.000	-70.000	0.000	0.000
3	2.100	-70.000	0.000	0.000
3	2.200	-70.000	0.000	0.000
3	2.300	-70.000	0.000	0.000
3	2.400	-70.000	0.000	0.000
3	2.500	-70.000	0.000	0.000
3	2.600	-70.000	0.000	0.000
3	2.700	-70.000	0.000	0.000
3	2.800	-70.000	0.000	0.000
3	2.900	-70.000	0.000	0.000
3	3.000	-70.000	0.000	0.000
1	3.100	-70.000	0.000	0.000
1	3.200	-70.000	0.000	0.000
1	3.300	-70.000	0.000	0.000
1	3.400	-70.000	0.000	0.000
1	3.500	-70.000	0.000	0.000
1	3.600	-70.000	0.000	0.000
1	3.700	-70.000	0.000	0.000
1	3.800	-70.000	0.000	0.000
1	3.900	-70.000	0.000	0.000
1	4.000	-70.000	0.000	0.000
3	3.100	-70.000	0.000	0.000
3	3.200	-70.000	0.000	0.000
3	3.300	-70.000	0.000	0.000
3	3.400	-70.000	0.000	0.000
3	3.500	-70.000	0.000	0.000
3	3.600	-70.000	0.000	0.000
3	3.700	-70.000	0.000	0.000
3	3.800	-70.000	0.000	0.000
3	3.900	-70.000	0.000	0.000
3	4.000	-70.000	0.000	0.000
1	4.100	-70.000	0.000	0.000
1	4.200	-70.000	0.000	0.000
1	4.300	-70.000	0.000	0.000
1	4.400	-70.000	0.000	0.000
1	4.500	-70.000	0.000	0.000
1	4.600	-70.000	0.000	0.000
1	4.700	-70.000	0.000	0.000
1	4.800	-70.000	0.000	0.000
1	4.900	-70.000	0.000	0.000
1	5.000	-70.000	0.000	0.000
3	4.100	-70.000	0.000	0.000
3	4.200	-70.000	0.000	0.000
3	4.300	-70.000	0.000	0.000
3	4.400	-70.000	0.000	0.000
3	4.500	-70.000	0.000	0.000
3	4.600	-70.000	0.000	0.000
3	4.700	-70.000	0.000	0.000
3	4.800	-70.000	0.000	0.000
3	4.900	-70.000	0.000	0.000
3	5.000	-70.000	0.000	0.000
1	5.100	-70.000	0.000	0.000
1	5.200	-70.000	0.000	0.000
1	5.300	-70.000	0.000	0.000
1	5.400	-70.000	0.000	0.000
1	5.500	-70.000	0.000	0.000
1	5.600	-70.000	0.000	0.000
1	5.700	-70.000	0.000	0.000
1	5.800	-70.000	0.000	0.000
1	5.900	-70.000	0.000	0.000
1	6.000	-70.000	0.000	0.000
3	5.100	-70.000	0.000	0.000
3	5.200	-70.000	0.000	0.000
3	5.300	-70.000	0.000	0.000
3	5.400	-70.000	0.000	0.000
3	5.500	-70.000	0.000	0.000
3	5.600	-70.000	0.000	0.000
3	5.700	-70.000	0.000	0.000
3	5.800	-70.000	0.000	0.000
3	5.900	-70.000	0.000	0.000
3	6.000	-70.000	0.000	0.000
1	6.100	-70.000	0.000	0.000
1	6.200	-70.000	0.000	0.000
1	6.300	-70.000	0.000	0.000
1	6.400	-70.000	0.000	0.000
1	6.500	-70.000	0.000	0.000
1	6.600	-70.000	0.000	0.000
1	6.700	-70.000	0.000	0.000
1	6.800	-70.000	0.000	0.000
1	6.900	-70.000	0.000	0.000
1	7.000	-70.000	0.000	0.000
3	6.100	-70.000	0.000	0.000
3	6.200	-70.000	0.000	0.000
3	6.300	-70.000	0.000	0.000
3	6.400	-70.000	0.000	0.000
3	6.500	-70.000	0.000	0.000
3	6.600	-70.000	0.000	0.000
3	6.700	-70.000	0.000	0.000
3	6.800	-70.000	0.000	0.000
3	6.900	-70.000	0.000	0.000
3	7.000	-70.000	0.000	0.000
1	7.100	-70.000	0.000	0.000
1	7.200	-70.000	0.000	0.000
1	7.300	-70.000	0.000	0.000
1	7.400	-70.000	0.000	0.000
1	7.500	-70.000	0.000	0.000
1	7.600	-70.000	0.000	0.000
1	7.700	-70.000	0.000	0.000
1	7.800	-70.000	0.000	0.000
1	7.900	-70.000	0.000	0.000
1	8.000	-70.000	0.000	0.000
3	7.100	-70.000	0.000	0.000
3	7.200	-70.000	0.000	0.000
3	7.300	-70.000	0.000	0.000
3	7.400	-70.000	0.000	0.000
3	7.500	-70.000	0.000	0.000
3	7.600	-70.000	0.000	0.000
3	7.700	-70.000	0.000	0.000
3	7.800	-70.000	0.000	0.000
3	7.900	-70.000	0.000	0.000
3	8.000	-70.000	0.000	0.000
1	8.100	-70.000	0.000	0.000
1	8.200	-70.000	0.000	0.000
1	8.300	-70.000	0.000	0.000
1	8.400	-70.000	0.000	0.000
1	8.500	-70.000	0.000	0.000
1	8.600	-70.000	0.000	0.000
1	8.700	-70.000	0.000	0.000
1	8.800	-70.000	0.000	0.000
1	8.900	-70.000	0.000	0.000
1	9.000	-70.000	0.000	0.000
3	8.100	-70.000	0.000	0.000
3	8.200	-70.000	0.000	0.000
3	8.300	-70.000	0.000	0.000
3	8.400	-70.000	0.000	0.000
3	8.500	-70.000	0.000	0.000
3	8.600	-70.000	0.000	0.000
3	8.700	-70.000	0.000	0.000
3	8.800	-70.000	0.000	0.000
3	8.900	-70.000	0.000	0.000
3	9.000	-70.000	0.000	0.000
1	9.100	-70.000	0.000	0.000
1	9.200	-70.000	0.000	0.000
1	9.300	-70.000	0.000	0.000
1	9.400	-70.000	0.000	0.000
1	9.500	-70.000	0.000	0.000
1	9.600	-70.000	0.000	0.000
1	9.700	-70.000	0.000	0.000
1	9.800	-70.000	0.000	0.000
1	9.900	-70.000	0.000	0.000
1	10.000	-70.000	0.000	0.000
3	9.100	-70.000	0.000	0.000
3	9.200	-70.000	0.000	0.000
3	9.300	-70.000	0.000	0.000
3	9.400	-70.000	0.000	0.000
3	9.500	-70.000	0.000	0.000
3	9.600	-70.000	0.000	0.000
3	9.700	-70.000	0.000	0.000
3	9.800	-70.000	0.000	0.000
3	9.900	-70.000	0.000	0.000
3	10.000	-70.000	0.000	0.000
1	10.100	-70.000	0.000	0.000
1	10.200	-70.000	0.000	0.000
1	10.300	-70.000	0.000	0.000
1	10.400	-70.000	0.000	0.000
1	10.500	-70.000	0.000	0.000
1	10.600	-70.000	0.000	0.000
1	10.700	-70.000	0.000	0.000
1	10.800	-70.000	0.000	0.000
1	10.900	-70.000	0.000	0.000
1	11.000	-70.000	0.000	0.000
3	10.100	-70.000	0.000	0.000
3	10.200	-70.000	0.000	0.000
3	10.300	-70.000	0.000	0.000
3	10.400	-70.000	0.000	0.000
3	10.500	-70.000	0.000	0.000
3	10.600	-70.000	0.000	0.000
3	10.700	-70.000	0.000	0.000
3	10.800	-70.000	0.000	0.000
3	10.900	-70.000	0.000	0.000
3	11.000	-70.000	0.000	0.000
1	11.100	-69.858	9.838	0.000
1	11.200	-69.471	17.804	0.000
1	11.300	-68.892	24.165	0.000
1	11.400	-68.168	29.154	0.000
1	11.500	-67.339	32.974	0.000
1	11.600	-66.438	35.804	0.000
1	11.700	-65.492	37.796	0.000
1	11.800	-64.524	39.085	0.000
1	11.900	-63.553	39.786	0.000
1	12.000	-62.591	40.000	0.000
3	11.100	-69.858	9.838	0.000
3	11.200	-69.471	17.804	0.000
3	11.300	-68.892	24.165	0.000
3	11.400	-68.168	29.154	0.000
3	11.500	-67.339	32.974	0.000
3	11.600	-66.438	35.804	0.000
3	11.700	-65.492	37.796	0.000
3	11.800	-64.524	39.085	0.000
3	11.900	-63.553	39.786	0.000
3	12.000	-62.591	40.000	0.000
1	12.100	-61.652	39.813	0.000
1	12.200	-60.741	39.299	0.000
1	12.300	-59.867	38.523	0.000
1	12.400	-59.033	37.538	0.000
1	12.500	-58.241	36.392	0.000
1	12.600	-57.494	35.124	0.000
1	12.700	-56.793	33.768	0.000
1	12.800	-56.136	32.352	0.000
1	12.900	-55.524	30.899	0.000
1	13.000	-70.000	29.430	0.000
3	12.100	-61.652	39.813	0.000
3	12.200	-60.741	39.299	0.000
3	12.300	-59.867	38.523	0.000
3	12.400	-59.033	37.538	0.000
3	12.500	-58.241	36.392	0.000
3	12.600	-57.494	35.124	0.000
3	12.700	-56.793	33.768	0.000
3	12.800	-56.136	32.352	0.000
3	12.900	-55.524	30.899	0.000
3	13.000	-70.000	29.430	0.000
1	13.100	-70.000	27.961	0.000
1	13.200	-70.000	26.505	0.000
1	13.300	-70.000	25.073	0.000
1	13.400	-70.000	23.673	0.000
1	13.500	-70.000	22.313	0.000
1	13.600	-70.000	20.997	0.000
1	13.700	-70.000	19.730	0.000
1	13.800	-70.000	18.513	0.000
1	13.900	-70.000	17.350	0.000
1	14.000	-70.000	16.240	0.000
3	13.100	-70.000	27.961	0.000
3	13.200	-70.000	26.505	0.000
3	13.300	-70.000	25.073	0.000
3	13.400	-70.000	23.673	0.000
3	13.500	-70.000	22.313	0.000
3	13.600	-70.000	20.997	0.000
3	13.700	-70.000	19.730	0.000
3	13.800	-70.000	18.513	0.000
3	13.900	-70.000	17.350	0.000
3	14.000	-70.000	16.240	0.000
1	14.100	-70.000	15.185	0.000
1	14.200	-70.000	14.183	0.000
1	14.300	-70.000	13.234	0.000
1	14.400	-70.000	12.338	0.000
1	14.500	-70.000	11.492	0.000
1	14.600	-70.000	10.695	0.000
1	14.700	-70.000	9.946	0.000
1	14.800	-70.000	9.243	0.000
1	14.900	-70.000	8.584	0.000
1	15.000	-70.000	7.966	0.000
3	14.100	-70.000	15.185	0.000
3	14.200	-70.000	14.183	0.000
3	14.300	-70.000	13.234	0.000
3	14.400	-70.000	12.338	0.000
3	14.500	-70.000	11.492	0.000
3	14.600	-70.000	10.695	0.000
3	14.700	-70.000	9.946	0.000
3	14.800	-70.000	9.243	0.000
3	14.900	-70.000	8.584	0.000
3	15.000	-70.000	7.966	0.000
1	15.100	-69.786	7.388	0.000
1	15.200	-69.590	6.848	0.000
1	15.300	-69.410	6.344	0.000
1	15.400	-69.245	5.874	0.000
1	15.500	-69.094	5.436	0.000
1	15.600	-68.956	5.028	0.000
1	15.700	-68.831	4.648	0.000
1	15.800	-68.716	4.295	0.000
1	15.900	-68.611	3.967	0.000
1	16.000	-68.516	3.663	0.000
3	15.100	-69.786	7.388	0.000
3	15.200	-69.590	6.848	0.000
3	15.300	-69.410	6.344	0.000
3	15.400	-69.245	5.874	0.000
3	15.500	-69.094	5.436	0.000
3	15.600	-68.956	5.028	0.000
3	15.700	-68.831	4.648	0.000
3	15.800	-68.716	4.295	0.000
3	15.900	-68.611	3.967	0.000
3	16.000	-68.516	3.663	0.000
1	16.100	-68.439	3.381	2.586
1	16.200	-68.386	3.119	4.919
1	16.300	-68.354	2.877	7.019
1	16.400	-68.343	2.652	8.902
1	16.500	-68.349	2.444	10.585
1	16.600	-68.372	2.252	12.083
1	16.700	-68.408	2.074	13.409
1	16.800	-68.457	1.909	14.577
1	16.900	-68.516	1.757	15.599
1	17.000	-68.586	1.617	16.487
3	16.100	-68.439	3.381	2.586
3	16.200	-68.386	3.119	4.919
3	16.300	-68.354	2.877	7.019
3	16.400	-68.343	2.652	8.902
3	16.500	-68.349	2.444	10.585
3	16.600	-68.372	2.252	12.083
3	16.700	-68.408	2.074	13.409
3	16.800	-68.457	1.909	14.577
3	16.900	-68.516	1.757	15.599
3	17.000	-68.586	1.617	16.487
1	17.100	-68.663	1.488	17.251
1	17.200	-68.747	1.368	17.902
1	17.300	-68.837	1.258	18.448
1	17.400	-68.931	1.156	18.898
1	17.500	-69.030	1.063	19.260
1	17.600	-69.131	0.976	19.542
1	17.700	-69.235	0.897	19.751
1	17.800	-69.341	0.823	19.893
1	17.900	-69.447	0.756	19.974
1	18.000	-69.554	0.694	20.000
3	17.100	-68.663	1.488	17.251
3	17.200	-68.747	1.368	17.902
3	17.300	-68.837	1.258	18.448
3	17.400	-68.931	1.156	18.898
3	17.500	-69.030	1.063	19.260
3	17.600	-69.131	0.976	19.542
3	17.700	-69.235	0.897	19.751
3	17.800	-69.341	0.823	19.893
3	17.900	-69.447	0.756	19.974
3	18.000	-69.554	0.694	20.000
1	18.100	-69.662	0.637	19.976
1	18.200	-69.768	0.584	19.906
1	18.300	-69.875	0.536	19.796
1	18.400	-69.980	0.492	19.650
1	18.500	-70.083	0.451	19.470
1	18.600	-70.185	0.414	19.261
1	18.700	-70.286	0.379	19.027
1	18.800	-70.384	0.347	18.769
1	18.900	-70.481	0.318	18.491
1	19.000	-70.575	0.292	18.196
3	18.100	-69.662	0.637	19.976
3	18.200	-69.768	0.584	19.906
3	18.300	-69.875	0.536	19.796
3	18.400	-69.980	0.492	19.650
3	18.500	-70.083	0.451	19.470
3	18.600	-70.185	0.414	19.261
3	18.700	-70.286	0.379	19.027
3	18.800	-70.384	0.347	18.769
3	18.900	-70.481	0.318	18.491
3	19.000	-70.575	0.292	18.196
1	19.100	-70.666	0.267	17.885
1	19.200	-70.756	0.245	17.562
1	19.300	-70.843	0.224	17.228
1	19.400	-70.927	0.205	16.884
1	19.500	-71.009	0.188	16.533
1	19.600	-71.088	0.172	16.176
1	19.700	-71.164	0.158	15.814
1	19.800	-71.238	0.144	15.450
1	19.900	-71.310	0.132	15.083
1	20.000	-71.379	0.121	14.715
3	19.100	-70.666	0.267	17.885
3	19.200	-70.756	0.245	17.562
3	19.300	-70.843	0.224	17.228
3	19.400	-70.927	0.205	16.884
3	19.500	-71.009	0.188	16.533
3	19.600	-71.088	0.172	16.176
3	19.700	-71.164	0.158	15.814
3	19.800	-71.238	0.144	15.450
3	19.900	-71.310	0.132	15.083
3	20.000	-71.379	0.121	14.715
"""


if __name__ == "__main__":
    unittest.main()
